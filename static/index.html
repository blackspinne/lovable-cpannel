<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Lovable → cPanel (Slug)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 32px; color: #111827; }
    .card { max-width: 820px; margin: 0 auto; background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 24px 28px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    h1 { font-size: 34px; margin: 0 0 8px; }
    p.muted { color: #6b7280; margin-top: 4px; }
    label { display:block; font-weight:600; margin:18px 0 6px; }
    input[type="text"] { width:100%; padding:12px 14px; border:1px solid #d1d5db; border-radius:10px; font-size:16px; }
    input[type="file"] { width:100%; padding:10px; border:1px dashed #d1d5db; border-radius:10px; background:#fafafa; }
    button { padding:12px 16px; border-radius:10px; border:0; background:#2563eb; color:#fff; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .row { display:flex; gap:12px; align-items:center; margin-top:16px; }
    .error { margin-top:10px; color:#b91c1c; font-weight:600; font-size:14px; }
    .status { margin-top:10px; color:#374151; font-size:14px; }
    progress { width:100%; height:14px; margin-top:10px; }
    .hint { margin-top:16px; color:#6b7280; font-size:14px; }
    .pill { display:inline-block; background:#f3f4f6; color:#111827; border-radius:999px; padding:4px 10px; font-size:12px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Lovable → cPanel (Slug)</h1>
    <p class="muted">Envie o ZIP do Lovable e informe a slug. Vamos devolver um <b>site.zip</b> pronto para subir no cPanel.</p>

    <form id="form">
      <label for="slug">Slug (ex.: bancario)</label>
      <input id="slug" type="text" placeholder="minha-slug" />

      <label for="file">ZIP do Lovable</label>
      <input id="file" type="file" accept=".zip" />

      <div class="row">
        <button id="go" type="submit">Gerar site.zip</button>
        <span id="badge" class="pill">aceita até 100 MB</span>
        <span id="btn-err" class="pill" style="display:none;background:#fee2e2;color:#991b1b;">erro</span>
      </div>

      <div id="error" class="error"></div>
      <div id="status" class="status"></div>
      <progress id="bar" value="0" max="100"></progress>

      <p class="hint">Depois, extraia o <code>site.zip</code> em <code>/public_html/&lt;slug&gt;/</code> no cPanel.</p>
    </form>
  </div>

<script>
const slugInput = document.querySelector("#slug");
const fileInput = document.querySelector("#file");
const btn = document.querySelector("#go");
const errPill = document.querySelector("#btn-err");
const statusEl = document.querySelector("#status");
const errorEl = document.querySelector("#error");
const bar = document.querySelector("#bar");

function setError(msg) {
  errorEl.textContent = msg || "";
  errPill.style.display = msg ? "inline-block" : "none";
}
function setStatus(msg) { statusEl.textContent = msg || ""; }
function setBusy(v){ btn.disabled = v; }

async function enqueue() {
  setBusy(true); setError(""); setStatus("Validando…"); bar.value = 0;

  const slug = (slugInput.value || "").trim();
  const file = fileInput.files?.[0];
  if (!slug) { setError("Informe a slug."); setBusy(false); return; }
  if (!file)  { setError("Selecione o ZIP do Lovable."); setBusy(false); return; }

  const fd = new FormData();
  fd.append("slug", slug);
  fd.append("file", file);

  try {
    const res = await fetch("/tasks", { method:"POST", body: fd });

    if (res.status === 413) {
      const data = await res.json().catch(()=>({detail:"ZIP muito grande"}));
      setError(data.detail || "ZIP muito grande (máx. 100 MB).");
      setBusy(false); return;
    }
    if (res.status === 429 || res.status === 503) {
      const data = await res.json().catch(()=>({detail:"Fila ocupada"}));
      setError(data.detail || "Fila ocupada. Tente novamente em alguns segundos.");
      setBusy(false); return;
    }
    if (res.status >= 500) {
      setError("Servidor acordando/instável (código " + res.status + "). Tente de novo em 10–20s.");
      setBusy(false); return;
    }
    if (!res.ok) {
      const data = await res.json().catch(()=>null);
      setError((data && data.detail) || ("Falha (" + res.status + ")."));
      setBusy(false); return;
    }

    const data = await res.json(); // {task_id, queue_position, message}
    setStatus(`Fila: ${data.message} • 0%`);
    await poll(data.task_id);
  } catch (e) {
    setError("Conexão falhou. Tente novamente.");
    setBusy(false);
  }
}

async function poll(taskId) {
  let lastPct = 0;
  while (true) {
    const res = await fetch("/tasks/" + taskId);
    if (!res.ok) {
      setError("Falha ao consultar status (" + res.status + ").");
      setBusy(false); return;
    }
    const st = await res.json();
    const pct = Math.max(0, Math.min(100, st.progress ?? 0));
    bar.value = pct;
    const eta = st.eta ? (" • ETL: " + st.eta) : "";
    setStatus(`Fila: ${st.status} • ${pct}%${eta}`);

    if (st.status === "done" && st.download_url) {
      setStatus("Concluído • 100%");
      window.location.href = st.download_url;  // baixa site.zip
      setBusy(false); return;
    }
    if (st.status === "error") {
      setError(st.message || "Erro ao processar.");
      setBusy(false); return;
    }
    const wait = (pct > lastPct) ? 900 : 1500;
    lastPct = pct;
    await new Promise(r => setTimeout(r, wait));
  }
}

document.querySelector("#form").addEventListener("submit", (e)=>{
  e.preventDefault();
  enqueue();
});
</script>
</body>
</html>
