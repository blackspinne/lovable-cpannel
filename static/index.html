<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Lovable → cPanel (Slug)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    :root { --bg:#0b0f1a; --card:#101827; --muted:#94a3b8; --text:#e2e8f0; --brand:#2563eb; --ok:#16a34a; --err:#ef4444; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:900px;margin:40px auto;padding:0 20px}
    .card{background:var(--card);border-radius:16px;padding:24px 28px;box-shadow:0 4px 30px rgba(0,0,0,.35)}
    h1{font-size:36px;margin:0 0 8px}
    p.muted{color:var(--muted);margin:0 0 24px}
    label{display:block;margin:16px 0 8px;color:#cbd5e1}
    input[type="text"]{width:100%;padding:12px 14px;border:1px solid #233148;border-radius:10px;background:#0c1320;color:var(--text)}
    .file{border:1px dashed #334155;background:#0b1220;padding:12px;border-radius:10px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    button{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    small.tag{display:inline-block;border-radius:999px;padding:6px 10px;font-size:12px;background:#172554;color:#93c5fd}
    .status{margin-top:10px;font-size:14px}
    .status .err{color:var(--err)}
    .status .ok{color:var(--ok)}
    .bar{height:8px;background:#0f172a;border-radius:99px;overflow:hidden;margin-top:8px}
    .bar > b{display:block;height:100%;width:0;background:linear-gradient(90deg,#2563eb,#22d3ee);transition:width .25s}
    a.dl{color:#93c5fd;text-decoration:none;font-weight:600}
    code{background:#0b1220;border:1px solid #1f2a44;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Lovable → cPanel (Slug)</h1>
    <p class="muted">Envie o ZIP do Lovable e informe a slug. Vamos devolver um <b>site.zip</b> pronto para subir no cPanel.</p>

    <div class="card">
      <label>Slug (ex.: bancario)</label>
      <input id="slug" type="text" placeholder="bancario" />

      <label>ZIP do Lovable</label>
      <div class="file">
        <input id="file" type="file" accept=".zip" />
      </div>

      <div class="row" style="margin-top:16px">
        <button id="go">Gerar site.zip</button>
        <small class="tag" id="cap">aceita até 100 MB</small>
        <small class="tag" id="chip" style="display:none">erro</small>
      </div>

      <div class="status" id="status"></div>
      <div class="bar"><b id="bar"></b></div>

      <p class="muted" style="margin-top:16px">
        Depois, extraia o <code>site.zip</code> em <code>/public_html/&lt;slug&gt;/</code> no cPanel.
      </p>
    </div>
  </div>

<script>
const go   = document.getElementById('go');
const file = document.getElementById('file');
const slug = document.getElementById('slug');
const stat = document.getElementById('status');
const bar  = document.getElementById('bar');
const chip = document.getElementById('chip');

function setErr(msg){
  chip.style.display='inline-block';
  chip.textContent='erro';
  stat.innerHTML = `<span class="err">Erro: ${escapeHtml(msg||'desconhecido')}</span>`;
}
function setInfo(msg){ stat.textContent = msg || ''; }
function setBar(p){ bar.style.width = (Math.max(0, Math.min(100, p)) || 0) + '%'; }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

async function poll(taskId){
  try{
    const r = await fetch(`/tasks/${taskId}`, { cache: 'no-store' });
    if(!r.ok){ setErr(`HTTP ${r.status}`); return; }
    const t = await r.json();

    let line = `Status: ${t.state}`;
    if (typeof t.progress === 'number') line += ` • ${t.progress}%`;
    if (t.eta_seconds != null) line += ` • ETA: ~${Math.max(0, t.eta_seconds)}s`;
    if (t.message) line += ` • ${t.message}`;
    setInfo(line);
    setBar(t.progress || 0);

    if (t.state === 'error'){ setErr(t.message||'Falha'); return; }
    if (t.state === 'done'){
      chip.style.display='none';
      const url = t.download_url || `/download/${taskId}`;
      stat.innerHTML = `<span class="ok">Pronto!</span> <a class="dl" href="${url}">Baixar site.zip</a>`;
      setBar(100);
      return;
    }
    setTimeout(()=>poll(taskId), 1200);
  }catch(e){
    setErr(e.message||e);
  }
}

function uploadWithProgress(fd){
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/tasks');

    // progresso do upload (0–30%)
    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        const pct = Math.round((e.loaded / e.total) * 30);
        setInfo(`Enviando... ${pct}%`);
        setBar(pct);
      } else {
        setInfo('Enviando...');
        setBar(15);
      }
    };

    xhr.onload = () => {
      if (xhr.status >= 200 && xhr.status < 300) {
        try { resolve(JSON.parse(xhr.responseText)); }
        catch(err){ reject(err); }
      } else {
        reject(new Error(`HTTP ${xhr.status}: ${xhr.responseText}`));
      }
    };
    xhr.onerror = () => reject(new Error('Falha de rede no upload'));
    xhr.send(fd);
  });
}

go.onclick = async () => {
  chip.style.display='none';
  stat.textContent = '';
  setBar(0);

  const f = file.files[0];
  const s = (slug.value||'').trim();
  if(!s){ setErr('Informe a slug.'); return; }
  if(!f){ setErr('Envie o arquivo .zip do Lovable.'); return; }

  const fd = new FormData();
  fd.append('slug', s);
  fd.append('file', f);

  go.disabled = true;
  try{
    const { task_id } = await uploadWithProgress(fd);  // 0→30%
    setInfo('Enfileirado. Aguardando processamento...');
    poll(task_id);                                     // 30→100%
  }catch(e){
    setErr(e.message||e);
  }finally{
    go.disabled = false;
  }
};
</script>
</body>
</html>
